# scp -r /home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/*  user@node16:/home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/
# scp -r /home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/*  user@node17:/home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/
# scp -r /home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/*  user@node18:/home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/
# scp -r /home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/*  user@node19:/home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/
# scp -r /home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/*  user@node20:/home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/
# scp -r /home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/*  user@node21:/home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/
# scp -r /home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/*  user@node22:/home/user/mzq/workspaces/project/dear_pytorch/ATC24-FG-MGS/fgmgs_ours/


# HOROVOD_GPU_OPERATIONS=NCCL HOROVOD_CACHE_CAPACITY=0 bash run.sh
# dnn="${dnn:-resnet20}"
# source exp_configs/$dnn.conf
# nworkers="${nworkers:-4}"

# 101
# 44549160 *4/1024 = 174020.15625


# 0.1k
# density="${density:-0.000000574646076}"


# 1k
# density="${density:-0.00000574646076}"

# 10k
# density="${density:-0.0000574646076}"

# 100k
# density="${density:-0.000574646076}"

# 1000k
# density="${density:-0.00574646076}"

# 10000k
# density="${density:-0.0574646076}"

# 100000k
density="${density:-0.574646076}"

# 150000k
# density="${density:-0.861969114}"

# 152
# 60192808*4/1024 = 235128.15625
# 200000k
# density="${density:-0.8505999587}"

# density="${density:-0.01}"
threshold="${threshold:-8192}"
# compressor="${compressor:-topk}"
compressor="${compressor:-eftopk}"
max_epochs="${max_epochs:-80}"
nwpernode=4
nstepsupdate=1
PY=python


HOROVOD_GPU_OPERATIONS=NCCL HOROVOD_CACHE_CAPACITY=0 horovodrun -np 8 -H node15:1,node16:1,node17:1,node18:1,node19:1,node20:1,node21:1,node22:1   python  pytorch_cifar100_resnet101_time.py  --epochs $max_epochs --density $density --compressor $compressor --threshold $threshold

# 25Gbps
# 0.1k = [[0.0041179656982421875], [0.003919363021850586], [0.011768817901611328], [0.0038611888885498047], [0.004126787185668945], [0.00526738166809082], [0.004214763641357422], [0.01775050163269043], [0.006400346755981445], [0.006075620651245117], [0.006596088409423828], [0.012271404266357422], [0.0073049068450927734],
# 1k =  [[0.004702329635620117], [0.004426002502441406], [0.006860256195068359], [0.005398988723754883], [0.007683753967285156], [0.005567073822021484], [0.004902362823486328], [0.007025003433227539], [0.005201578140258789], [0.00822591781616211], [0.004152536392211914], [0.00533747673034668], [0.007905244827270508],
# 6.75k = 0.0015125274658203125
# 10k = [[0.011170387268066406], [0.007164716720581055], [0.00807642936706543], [0.005961894989013672], [0.006506919860839844], [0.018954992294311523], [0.010447263717651367], [0.006433725357055664], [0.006229877471923828], [0.018814802169799805], [0.011809587478637695], [0.006885051727294922], [0.0061185359954833984], [0.019100427627563477], [0.007082700729370117], [0.011896610260009766], [0.006299018859863281], [0.02025127410888672], [0.0072672367095947266], [0.011243581771850586]]
# 100k = [[0.011075973510742188], [0.006595134735107422], [0.006005764007568359], [0.0060272216796875], [0.008306741714477539], [0.0059719085693359375], [0.005752086639404297], [0.005872249603271484], [0.006841421127319336], [0.005892515182495117], [0.0056612491607666016], [0.005585193634033203],
# 1000k = [[0.030220985412597656], [0.017979145050048828], [0.018564462661743164], [0.02210688591003418], [0.02178168296813965], [0.02104783058166504], [0.020754575729370117], [0.019115209579467773], [0.016987323760986328], [0.01653265953063965], [0.015837907791137695], [0.01654195785522461],
# 10000k = [[0.12149715423583984], [0.11170434951782227], [0.10846257209777832], [0.1078341007232666], [0.10873079299926758], [0.1081998348236084], [0.10628390312194824], [0.10929727554321289], [0.11005139350891113], [0.11142444610595703], [0.1079549789428711], [0.10632872581481934], [0.10946798324584961], [0.10777044296264648], [0.10573005676269531], [0.1065835952758789], [0.11065030097961426], [0.10877799987792969], [0.10793519020080566],
# 100000k = [[0.967970609664917], [0.9556348323822021], [0.9529705047607422], [0.9546036720275879], [0.9522168636322021], [0.9476020336151123], [0.9498670101165771], [0.9507250785827637], [0.9492425918579102], [0.9513697624206543], [0.9463450908660889], [0.9504077434539795], [0.9500365257263184]

# Result
# 0.006860256195068359, 0.0065064716720581055, 0.0060272216796875, 0.018564462661743164, 0.1078341007232666, 1.015467643737793


# 1Gbps
# 0.1k =  [0.003959178924560547, 0.0036144256591796875, 0.0035088062286376953, 0.003383159637451172, 0.003819704055786133, 0.0035257339477539062, 0.0034499168395996094, 0.003462553024291992, 0.003075122833251953, 0.0031418800354003906]
# [[0.003935813903808594], [0.0037078857421875], [0.0034894943237304688], [0.0037903785705566406], [0.0038862228393554688], [0.0035469532012939453], [0.0032019615173339844], [0.0036568641662597656], [0.003595113754272461], [0.005577802658081055], [0.004575252532958984], [0.0052645206451416016], [0.003415346145629883], [0.0034515857696533203], [0.0031251907348632812], [0.004029750823974609], [0.0032477378845214844], [0.003437519073486328], [0.003337860107421875], [0.004061222076416016]]


# 1k =  [0.003391265869140625, 0.0028023719787597656, 0.002850055694580078, 0.0031778812408447266, 0.0044629573822021484, 0.0032193660736083984, 0.002988100051879883, 0.003168821334838867, 0.00406956672668457, 0.0029811859130859375]
# [[0.005186796188354492], [0.005552768707275391], [0.0037031173706054688], [0.003391265869140625], [0.0041234493255615234], [0.0029098987579345703], [0.0028228759765625], [0.0029184818267822266], [0.002950906753540039], [0.0032701492309570312], [0.003391265869140625], [0.0028023719787597656], [0.002850055694580078], [0.0031778812408447266], [0.0044629573822021484], [0.0032193660736083984], [0.002988100051879883], [0.003168821334838867], [0.00406956672668457], [0.0029811859130859375]]


# 10k =  [0.005120992660522461, 0.004906892776489258, 0.0049457550048828125, 0.0043621063232421875, 0.004557609558105469, 0.0047223567962646484, 0.004592180252075195, 0.0043487548828125, 0.004214048385620117, 0.005822658538818359]
# [[0.0050127506256103516], [0.006601572036743164], [0.005385160446166992], [0.00436854362487793], [0.004271507263183594], [0.004159450531005859], [0.004294633865356445], [0.004698991775512695], [0.004793405532836914], [0.005294322967529297], [0.005120992660522461], [0.004906892776489258], [0.0049457550048828125], [0.0043621063232421875], [0.004557609558105469], [0.0047223567962646484], [0.004592180252075195], [0.0043487548828125], [0.004214048385620117], [0.005822658538818359]]


# 100k = [0.017896652221679688, 0.02143549919128418, 0.019418001174926758, 0.018282175064086914, 0.023864030838012695, 0.021050453186035156, 0.019936323165893555, 0.020632505416870117, 0.021234512329101562, 0.02164745330810547]
# [0.013701677322387695, 0.01692509651184082, 0.01620650291442871, 0.014581918716430664, 0.01641702651977539, 0.0175478458404541, 0.016205549240112305, 0.01663351058959961, 0.01676344871520996, 0.016134977340698242]
# [[0.023293018341064453], [0.02266407012939453], [0.023042917251586914], [0.022965669631958008], [0.02147674560546875], [0.020430326461791992], [0.021561861038208008], [0.020641088485717773], [0.022698640823364258], [0.021641969680786133], [0.017896652221679688], [0.02143549919128418], [0.019418001174926758], [0.018282175064086914], [0.023864030838012695], [0.021050453186035156], [0.019936323165893555], [0.020632505416870117], [0.021234512329101562], [0.02164745330810547]]


# 1000k = [0.12176203727722168, 0.1219778060913086, 0.12599658966064453, 0.12212181091308594, 0.12195348739624023, 0.12161850929260254, 0.126129150390625, 0.12189149856567383, 0.12157845497131348, 0.12180972099304199]
# [[0.12494826316833496], [0.12149524688720703], [0.1217966079711914], [0.121490478515625], [0.12165093421936035], [0.12154603004455566], [0.12159848213195801], [0.12101125717163086], [0.12187933921813965], [0.12178206443786621], [0.12176203727722168], [0.1219778060913086], [0.12599658966064453], [0.12212181091308594], [0.12195348739624023], [0.12161850929260254], [0.126129150390625], [0.12189149856567383], [0.12157845497131348], [0.12180972099304199]]
# 4.47it/s

# 10000k = [[0.12149715423583984], [0.11170434951782227], [0.10846257209777832], [0.1078341007232666], [0.10873079299926758], [0.1081998348236084], [0.10628390312194824], [0.10929727554321289], [0.11005139350891113], [0.11142444610595703], [0.1079549789428711], [0.10632872581481934], [0.10946798324584961], [0.10777044296264648], [0.10573005676269531], [0.1065835952758789], [0.11065030097961426], [0.10877799987792969], [0.10793519020080566],
# 0.706019963268s
# 1.31s/it, 0.769230769it/s

# 100000k = [[0.967970609664917], [0.9556348323822021], [0.9529705047607422], [0.9546036720275879], [0.9522168636322021], [0.9476020336151123], [0.9498670101165771], [0.9507250785827637], [0.9492425918579102], [0.9513697624206543], [0.9463450908660889], [0.9504077434539795], [0.9500365257263184]
# 6.9535582677
# 12.38s/it 0.08032128514it/s

# 150000k 
# 0.006860256195068359, 0.0065064716720581055, 0.0060272216796875, 0.018564462661743164, 0.1078341007232666, 1.015467643737793
# 18.53s/it

# 1Gbps Result
# [ 0.0034078857421875, 0.0037031173706054688, 0.0050127506256103516, 0.02266407012939453, 0.12494826316833496, 0.706019963268, 6.9535582677]




# 10Gbps

# 0.1k = [0.013519763946533203, 0.005235433578491211, 0.003707408905029297, 0.0032148361206054688, 0.011497259140014648, 0.004355430603027344, 0.004332780838012695, 0.003580808639526367, 0.012410640716552734, 0.005758523941040039]
# [[0.009247064590454102], [0.010317087173461914], [0.004042863845825195], [0.0060558319091796875], [0.0051043033599853516], [0.014361858367919922], [0.004162788391113281], [0.004555463790893555], [0.00458979606628418], [0.010847091674804688], [0.004141807556152344], [0.004201173782348633], [0.004076957702636719], [0.013684272766113281], [0.0043141841888427734], [0.004670143127441406], [0.004034519195556641], [0.011879444122314453], [0.00732111930847168], [0.006715297698974609]]


# 1k =   [0.0026865005493164062, 0.003423452377319336, 0.005631208419799805, 0.0030450820922851562, 0.003913402557373047, 0.002220630645751953, 0.0025763511657714844, 0.002828359603881836, 0.0047838687896728516, 0.002593994140625]
# [[0.00953817367553711], [0.005149126052856445], [0.003201007843017578], [0.0024116039276123047], [0.002365589141845703], [0.0051727294921875], [0.002067089080810547], [0.002468585968017578], [0.0030362606048583984], [0.003002643585205078], [0.0026865005493164062], [0.003423452377319336], [0.005631208419799805], [0.0030450820922851562], [0.003913402557373047], [0.002220630645751953], [0.0025763511657714844], [0.002828359603881836], [0.0047838687896728516], [0.002593994140625]]


# 10k = [0.005596637725830078, 0.005778312683105469, 0.005776882171630859, 0.00567317008972168, 0.0044918060302734375, 0.005722522735595703, 0.005701780319213867, 0.004765510559082031, 0.005949735641479492, 0.005410671234130859]
#  [[0.006230831146240234], [0.005919933319091797], [0.006351470947265625], [0.005024909973144531], [0.005126953125], [0.005392789840698242], [0.0047817230224609375], [0.005354881286621094], [0.005717039108276367], [0.0042531490325927734], [0.005596637725830078], [0.005778312683105469], [0.005776882171630859], [0.00567317008972168], [0.0044918060302734375], [0.005722522735595703], [0.005701780319213867], [0.004765510559082031], [0.005949735641479492], [0.005410671234130859]]


# 100k = [0.015419483184814453, 0.008344173431396484, 0.006284952163696289, 0.007556438446044922, 0.016588926315307617, 0.0059032440185546875, 0.005579233169555664, 0.007351875305175781, 0.01608896255493164, 0.007229328155517578]
# [[0.005007505416870117], [0.007996559143066406], [0.00899195671081543], [0.009435415267944336], [0.007876157760620117], [0.009173870086669922], [0.007416248321533203], [0.0052988529205322266], [0.006486415863037109], [0.011379718780517578], [0.008242130279541016], [0.004675149917602539], [0.0074884891510009766], [0.009826421737670898], [0.007600545883178711], [0.0056192874908447266], [0.005885124206542969], [0.01750779151916504], [0.009377717971801758], [0.008463382720947266]]


# 1000k =  [0.01883673667907715, 0.018338441848754883, 0.019115447998046875, 0.01912403106689453, 0.018497705459594727, 0.01904439926147461, 0.01859760284423828, 0.018451690673828125, 0.01845097541809082, 0.01859879493713379]
# [[0.019520998001098633], [0.018551349639892578], [0.019323348999023438], [0.01944446563720703], [0.018854856491088867], [0.01972651481628418], [0.01934957504272461], [0.019107580184936523], [0.019188404083251953], [0.01919841766357422], [0.01883673667907715], [0.018338441848754883], [0.019115447998046875], [0.01912403106689453], [0.018497705459594727], [0.01904439926147461], [0.01859760284423828], [0.018451690673828125], [0.01845097541809082], [0.01859879493713379]]


# 10000k = [0.1341996192932129, 0.13345980644226074, 0.13364696502685547, 0.13203692436218262, 0.1326134204864502, 0.13276147842407227, 0.13427233695983887, 0.13345980644226074, 0.134002685546875, 0.13276457786560059]
# [[0.13208723068237305], [0.13296008110046387], [0.1315295696258545], [0.13251876831054688], [0.134598970413208], [0.13610196113586426], [0.13426923751831055], [0.13283467292785645], [0.13245582580566406], [0.13192224502563477], [0.1341996192932129], [0.13345980644226074], [0.13364696502685547], [0.13203692436218262], [0.1326134204864502], [0.13276147842407227], [0.13427233695983887], [0.13345980644226074], [0.134002685546875], [0.13276457786560059]]


# 100000k = [1.257843255996704, 1.257761001586914, 1.2694168090820312, 1.2646005153656006, 1.2591381072998047, 1.2575726509094238, 1.2707653045654297, 1.2545781135559082, 1.2648656368255615, 1.2623779773712158]
# [[1.282965898513794], [1.2591156959533691], [1.2642076015472412], [1.264793872833252], [1.2738513946533203], [1.2629764080047607], [1.2618696689605713], [1.2588977813720703], [1.2649359703063965], [1.2621939182281494], [1.257843255996704], [1.257761001586914], [1.2694168090820312], [1.2646005153656006], [1.2591381072998047], [1.2575726509094238], [1.2707653045654297], [1.2545781135559082], [1.2648656368255615], [1.2623779773712158]]
# 1.50s/it


# 1Gbps Result
# [0.0034078857421875, 0.0037031173706054688, 0.0050127506256103516, 0.02266407012939453, 0.12494826316833496, 0.706019963268, 6.9535582677]

# 10Gbps Result
# [0.0030450820922851562,  0.003201007843017578,   0.005024909973144531, 0.007996559143066406, 0.018551349639892578 , 0.1315295696258545 , 1.2591156959533691]
